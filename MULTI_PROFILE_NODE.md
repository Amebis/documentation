# Introduction

As shown in the [Multi Profile](MULTI_PROFILE.md) and 
[Multi Node](MULTI_NODE.md) documentation it is possible to define multiple 
profiles, and run those profiles on multiple nodes.

This document is a combination of both, have multiple profiles _and_ nodes.

In the example below we have a VPN server running on `vpn.example.org` and 
three nodes, one in Amsterdam with name `ams1.vpn.example.org` and two in 
Frankfurt: `fra1.vpn.example.org` and `fra2.vpn.example.org`. The nodes only 
offer WireGuard.

We recommend you to follow the [Multi Node](MULTI_NODE.md) instructions to 
setup the "controller" and the "nodes" and then come back here.

# Configuration

The configuration file `/etc/vpn-user-portal/config.php` needs to be 
modified, you can remove the `default` profile that was there if you didn't
modify the default configuration yet.

```
'ProfileList' => [
    // Our Node in Amsterdam
    [
        'profileId' => 'ams',
        'displayName' => 'Amsterdam',
        'hostName' => 'ams1.vpn.example.org',
        'wRangeFour' => ['172.23.114.0/24', '10.123.94.0/24'],
        'wRangeSix' => ['fd36:2246:1d09:3014::/64', 'fdb6:21f2:f9c:34fb::/64'],
        'defaultGateway' => true,
        'dnsServerList' => ['9.9.9.9', '2620:fe::9'],
        'nodeUrl' => 'http://ams1.vpn.example.org:41194',
        'onNode' => 0,
    ],

    // Our Nodes in Frankfurt	
    [
        'profileId' => 'fra',
        'displayName' => 'Frankfurt',
        'hostName' => ['fra1.vpn.example.org', 'fra2.vpn.example.org'],
        'wRangeFour' => ['10.61.60.0/24', '10.7.192.0/24'],
        'wRangeSix' => ['fd85:f1d9:20b7:b74c::/64', 'fd89:79cb:b63c:717e::/64'],
        'defaultGateway' => true,
        'dnsServerList' => ['9.9.9.9', '2620:fe::9'],
        'nodeUrl' => ['http://fra1.vpn.example.org:41194', 'http://fra2.vpn.example.org:41194'],
        'onNode' => [2, 3],
    ],
],
```

You can see that if multiple nodes are configured for a profile, the `array` 
syntax is used to define multiple values. The `ams` profile has only one node,
so no need to use the `array` syntax. Of course, to keep things consistent, one
can use array syntax everywhere, which might be nicer.

The `onNode` option can be used to specify which node(s) run the particular 
profile. The count starts at `0`. The `ams` profile has only one node (`0`) and
the `fra` profile has two. We start the count for `fra` from `2`, so we could 
still add `1` as a future node for `ams` without creating a mess of the node
numbers.

For each of the nodes you need to generate a secret, the secret for node `0` 
is generated by default, so no need to still generate it:

```bash
$ sudo /usr/libexec/vpn-user-portal/generate-secrets --node 2
$ sudo /usr/libexec/vpn-user-portal/generate-secrets --node 3
```

Together with the instructions from [Multi Node](MULTI_NODE.md) you should be
able to get it to work!
